name: Develop ðŸš€

on:
  workflow_call:
jobs:

  build-and-deploy:
    runs-on: ubuntu-latest
    name: 'Build And Deploy'
    permissions:
      id-token: write	
      contents: read
      actions: read
    steps:

      - name: New build Started
        uses: 8398a7/action-slack@v3
        with:
          text: 'New Build and Deploy Started for Develop ðŸš€'
          status: 'cancelled'
          author_name: 'Frontend Build and Deploy'
          icon_url: 'https://avatars.githubusercontent.com/u/71592178?s=48&v=4'
          fields: repo,ref,message,author,eventName,workflow
          icon_emoji: ':rocket:'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_FRONTEND_APPS_BLD_ALRT_DEV }}
          
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          persist-credentials: false
          
      - name: Reconfigure git to use HTTP authentication
        run: >
          git config --global url."https://github.com/".insteadOf
          ssh://git@github.com/
      
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1	
        with:
          role-to-assume: 'arn:aws:iam::${{ secrets.AWS_DEV_ACCOUNT_ID }}:role/${{ secrets.AWS_ROLE_TO_DEPLOY_FRONTEND_APPS }}'
          aws-region: ${{ secrets.AWS_DEFAULT_REGION }}
          
      - name: Set up Node.js
        uses: actions/setup-node@v1			
        with:
          node-version: 14.x
      
      - name: Install dependencies
        if: ${{ github.repository != 'WeDeliverGitHub/sharedDependenciesWeb' }}	  
        run: |
            npm ci

      - name: Install shared dependencies
        if: ${{ github.repository == 'WeDeliverGitHub/sharedDependenciesWeb' }}	  
        run: |
            npm install

      - name: Set S3 variables
        id: S3_variables
        run: |
          if  [[ ${{ github.repository }} == "captainServiceFrontend" ]] ; then
            echo "catpain repo"
          elif [[ ${{ github.event.action }} == "labeled" ]] ; then
              echo "labled to unsupported environment"
          else
            echo "else if statement"

      - name: Build the project		  
        run: |
          npm run deploy --branch_name=develop
          
      - name: Deploy-to-S3
        uses: reggionick/s3-deploy@v3	
        with:
            folder: ${{ steps.S3_variables.outputs.folder }}
            bucket: ${{ steps.S3_variables.outputs.bucket }}
            bucket-region: ${{ secrets.AWS_DEFAULT_REGION }}
            dist-id: ${{ secrets.CLOUDFRONT_DEV_APPS_DISTRIBUTION_ID }}
            invalidation: ${{ steps.S3_variables.outputs.invalidation }}
            delete-removed: ${{ steps.S3_variables.outputs.delete-removed }}
            no-cache: true
            private: true

  
  
  send-workflow-success:
    runs-on: ubuntu-latest
    name: 'Send success notification'
    permissions:
      contents: read
      actions: read
    needs: [ build-and-deploy ]
    if: success()
    steps:

      - name: Send notification when a build is done DEVELOP
        uses: 8398a7/action-slack@v3
        with:
          author_name: 'Frontend Build and Deploy'
          icon_url: 'https://avatars.githubusercontent.com/u/71592178?s=48&v=4'
          status: 'success'
          text: '${{ github.event.repository.name }} Frontend App Build and Deploy Succeeded âœ…'
          fields: repo,message,commit,author,eventName,ref,workflow,job
          icon_emoji: 'âœ…'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_FRONTEND_APPS_BLD_ALRT_DEV }}
  
  
  
  send-workflow-failure:
    runs-on: ubuntu-latest
    name: 'Send fail notification'
    permissions:
      contents: read
      actions: read
    needs: [ build-and-deploy ]
    if: ${{ always() && contains(needs.*.result, 'failure') && !contains(needs.*.result, 'skipped') }}
    steps:

      - name: Send notification when a build is fail DEVELOP
        uses: 8398a7/action-slack@v3
        with:
          author_name: 'Frontend Build and Deploy'
          icon_url: 'https://avatars.githubusercontent.com/u/71592178?s=48&v=4'
          mention: 'here'
          status: 'failure'
          text: '${{ github.event.repository.name }} Frontend App Build or Deploy Failed ðŸ”´'
          fields: repo,message,commit,author,eventName,ref,workflow,job
          icon_emoji: 'ðŸ”´'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_FRONTEND_APPS_BLD_ALRT_DEV }}
